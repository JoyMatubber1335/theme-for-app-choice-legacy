{{ "product-video-carousel.css" | asset_url | stylesheet_tag }}

{%- style -%}
  .product-video-carousel-{{ section.id }} {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .product-video-carousel-{{ section.id }} {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  .product-video-carousel-{{ section.id }} .product-video-item {
    border-radius: {{ section.settings.card_border_radius }}px;
    cursor: pointer;
    transition: transform 0.3s ease;
    width: 268px;
    height: 412px;
  }

  .product-video-carousel-{{ section.id }} .product-video-container {
    position: relative;
    width: 100%;
    height: 340px;
    border-radius: {{ section.settings.card_border_radius }}px {{ section.settings.card_border_radius }}px 0 0;
    overflow: hidden;
  }
{%- endstyle -%}

<div class="product-video-carousel product-video-carousel-{{ section.id }}">
  <div class="product-video-carousel__container page-width flex gap-24 flex-col mobile-gap-16">
    {% if section.settings.heading != blank %}
      <h2 class="product-video-carousel__title fw-400 fs-36-lh-40-ls-0pct mobile-fs-21-lh-24-ls-1_2pct text-center">{{ section.settings.heading }}</h2>
    {% endif %}

    <slideshow-component 
      data-autoplay="{{ section.settings.autoplay }}"
      data-autoplay-delay="{{ section.settings.autoplay_delay | default: 5000 }}"
      data-pause-on-hover="{{ section.settings.pause_on_hover }}"
      data-slides-per-view-desktop="{{ section.settings.slides_per_view | default: 4 }}"
      data-show-partial-slides="true"
      data-show-progress-bar="false"
      data-carousel-mode="true"
      data-slide-width-mobile="268px"
      data-slide-width-tablet="268px"
      data-slide-width-desktop="268px"
    >
      <div class="swiper-container">
        <div class="swiper-wrapper flex gap-16">
          {% for block in section.blocks %}
            {% if block.settings.product != blank %}
              {% assign product = all_products[block.settings.product] %}
              {% assign has_video = false %}
              {% if block.settings.video_type == 'youtube' and block.settings.youtube_url != blank %}
                {% assign has_video = true %}
              {% elsif block.settings.video_type == 'url' and block.settings.video_url != blank %}
                {% assign has_video = true %}
              {% endif %}
              
              <div class="swiper-slide">
                <div class="product-video-item box-shadow{% if has_video %} has-video{% endif %}" data-block-id="{{ block.id }}">
                  <div class="product-video-container">
                    {% if block.settings.video_type == 'youtube' and block.settings.youtube_url != blank %}
                      {% assign youtube_id = block.settings.youtube_url | split: 'v=' | last | split: '&' | first %}
                      {% if youtube_id == blank %}
                        {% assign youtube_id = block.settings.youtube_url | split: 'youtu.be/' | last | split: '?' | first %}
                      {% endif %}
                      {% if youtube_id != blank %}
                        <iframe 
                          class="product-video-item__iframe"
                          src="https://www.youtube.com/embed/{{ youtube_id }}?autoplay=0&mute=1&loop=1&playlist={{ youtube_id }}&controls=0&showinfo=0&rel=0&modestbranding=1&enablejsapi=1"
                          loading="lazy"
                          allow="autoplay; encrypted-media"
                          data-video-type="youtube"
                          data-youtube-id="{{ youtube_id }}">
                        </iframe>
                      {% endif %}
                    {% elsif block.settings.video_type == 'url' and block.settings.video_url != blank %}
                      <video
                        style="width: 100%; height: 100%; object-fit: cover;"
                        class="product-video-item__video" 
                        muted 
                        loop 
                        playsinline
                        preload="metadata"
                        data-video-type="mp4">
                        <source src="{{ block.settings.video_url }}" type="video/mp4">
                      </video>
                    {% endif %}

                    {% unless has_video %}
                      {% if product.featured_image %}
                        {% render 'image',
                          image: product.featured_image,
                          width: 268,
                          height_attr: 340,
                          alt_text: product.title,
                          css_classes: 'product-video-item__video product-video-item__fallback-image',
                          loading: 'lazy',
                          width_attr: 268
                        %}
                      {% endif %}
                    {% endunless %}

                    {% if has_video %}
                      <div class="product-video-item__top-overlay">
                        <div class="product-video-item__top-text flex flex-col gap-9">
                          <div class="flex flex-wrap gap-9">
                            {% comment %} TODO: Add logo {% endcomment %}
                            {% comment %} {% render 'image',
                              image: 'https://placehold.co/600x400',
                              width: 40,
                              height_attr: 40,
                              alt_text: 'Choice Legacy Logo',
                              css_classes: 'choice-legacy-logo',
                              loading: 'lazy',
                              width_attr: 40
                            %} {% endcomment %}
                              <div class="choice-legacy-logo"></div>
                            <p class="product-video-item__main-text fw-500 fs-13-lh-16-ls-0_2">{{ block.settings.main_text | default: "Check out this amazing product!" }}</p>
                          </div>
                          <p class="product-video-item__sub-text fw-500 fs-13-lh-16-ls-0_2">{{ block.settings.sub_text | default: "Skincare routine for glowing skin" }}</p>
                        </div>
                        <button class="product-video-item__small-play" type="button" aria-label="Play video">
                          {% render "icon-play" %}
                          {% render "icon-pause" %}
                        </button>
                      </div>
                    {% endif %}
                  </div>

                  <div class="product-video-item__product-info">
                    {% if product.featured_image %}
                      {% render 'image',
                        image: product.featured_image,
                        width: 100,
                        height_attr: 100,
                        alt_text: product.title,
                        css_classes: 'product-video-item__product-image',
                        loading: 'lazy',
                        width_attr: 100
                      %}
                    {% endif %}
                    <div class="product-video-item__product-details flex flex-col justify-center gap-4">
                      {% if product.price %}
                        <p class="product-video-item__product-price fw-600 fs-16-lh-16-ls-0">
                          {{ product.price | money }}
                        </p>
                      {% endif %}

                      <h3 class="product-video-item__product-title fw-400 fs-12-lh-16-ls-0_6pct">{{ product.title }}</h3>
                    </div>
                  </div>

                  <a href="{{ product.url }}" class="product-video-item__link" aria-label="View {{ product.title }}">
                    <span class="visually-hidden">{{ product.title }}</span>
                  </a>
                </div>
              </div>
            {% else %}
              <div class="swiper-slide">
                <div class="product-video-item" data-block-id="{{ block.id }}">
                  <div class="product-video-container">
                    <div class="product-video-item__placeholder">
                      {{ 'product-1' | placeholder_svg_tag: "placeholder-svg" }}
                    </div>
                  </div>

                  <div class="product-video-item__product-info">
                    <div class="product-video-item__product-image">
                      {{  "product-1" | placeholder_svg_tag: "placeholder-svg" }}
                    </div>
                    <div class="product-video-item__product-details flex flex-col gap-4 fw-600 fs-16-lh-16-ls-0">
                      <p class="product-video-item__product-price">
                        {{ 'sections.product_video_carousel.placeholder.price' | t | default: '$0.00' }}
                      </p>
                      <h3 class="product-video-item__product-title fw-400 fs-12-lh-16-ls-0_6pct">{{ 'sections.product_video_carousel.placeholder.product_title' | t | default: 'Product Title' }}</h3>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </slideshow-component>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const videoItems = document.querySelectorAll('.product-video-item');
  
  videoItems.forEach((item, index) => {
    const video = item.querySelector('video[data-video-type="mp4"]');
    const iframe = item.querySelector('iframe[data-video-type="youtube"]');
    const smallPlayButton = item.querySelector('.product-video-item__small-play');
    
    if (video && smallPlayButton) {
      const toggleVideo = () => {
        if (video.paused) {
          const playPromise = video.play();
          if (playPromise !== undefined) {
            playPromise.then(() => {
              item.classList.add('playing');
            }).catch(error => {
              console.error('Video play failed:', error);
            });
          }
        } else {
          video.pause();
          item.classList.remove('playing');
        }
      };
      
      smallPlayButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleVideo();
      });
      
      video.addEventListener('play', () => {
        item.classList.add('playing');
      });
      
      video.addEventListener('pause', () => {
        item.classList.remove('playing');
      });
      
      video.addEventListener('ended', () => {
        item.classList.remove('playing');
      });
    }
    
    if (iframe && smallPlayButton) {
      const toggleYouTube = () => {
        const currentSrc = iframe.src;
        
        if (item.classList.contains('playing')) {
          iframe.src = currentSrc.replace('autoplay=1', 'autoplay=0');
          item.classList.remove('playing');
        } else {
          iframe.src = currentSrc.replace('autoplay=0', 'autoplay=1');
          item.classList.add('playing');
        }
      };
      
      smallPlayButton.addEventListener('click', (e) => {
        console.log('YouTube play button clicked');
        e.preventDefault();
        e.stopPropagation();
        toggleYouTube();
      });
    }
  });
});
</script>

<script src="{{ "slideshow.js" | asset_url }}" defer></script>

{% schema %}
{
  "name": "Product Video Carousel",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Watch & Shop",
      "label": "Heading"
    },
    {
      "type": "range",
      "id": "card_border_radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Card border radius",
      "default": 8
    },
    {
      "type": "range",
      "id": "slides_per_view",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "label": "Slides per view (desktop)"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "default": false,
      "label": "Auto-rotate slides"
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "min": 2000,
      "max": 9000,
      "step": 500,
      "default": 5000,
      "label": "Change slides every",
      "unit": "ms"
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "default": true,
      "label": "Pause on hover"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "product_video",
      "name": "Product Video",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "select",
          "id": "video_type",
          "label": "Video type",
          "options": [
            {
              "value": "youtube",
              "label": "YouTube"
            },
            {
              "value": "url",
              "label": "Video URL"
            }
          ],
          "default": "youtube"
        },
        {
          "type": "url",
          "id": "youtube_url",
          "label": "YouTube video URL",
          "info": "Full YouTube URL (e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ)"
        },
        {
          "type": "url",
          "id": "video_url",
          "label": "Video URL",
          "info": "Direct link to video file (MP4 recommended)"
        },
        {
          "type": "text",
          "id": "main_text",
          "label": "Main overlay text",
          "default": "Choice Legacy"
        },
        {
          "type": "text",
          "id": "sub_text",
          "label": "Sub overlay text",
          "default": "Skincare heroes this summer!"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Video Carousel",
      "blocks": [
        {
          "type": "product_video"
        },
        {
          "type": "product_video"
        },
        {
          "type": "product_video"
        },
        {
          "type": "product_video"
        }
      ]
    }
  ]
}
{% endschema %}